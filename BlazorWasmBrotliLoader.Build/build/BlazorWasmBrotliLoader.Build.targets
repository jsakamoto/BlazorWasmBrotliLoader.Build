<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="BlazorWasmBrotliLoader.RewriteHtml" AssemblyFile="$(MSBuildThisFileDirectory)../tools/BlazorWasmBrotliLoader.Build.dll" />
  <UsingTask TaskName="BlazorWasmBrotliLoader.UpdateServiceWorkerAssetsManifestJs" AssemblyFile="$(MSBuildThisFileDirectory)../tools/BlazorWasmBrotliLoader.Build.dll" />
  <UsingTask TaskName="BlazorWasmBrotliLoader.RecompressStaticFiles" AssemblyFile="$(MSBuildThisFileDirectory)../tools/BlazorWasmBrotliLoader.Build.dll" />

  <Target Name="BlazorWasmBrotliLoader_DefineProperties" DependsOnTargets="$(BeforeBlazorWasmBrotliLoader)">
    <PropertyGroup>
      <BroltiLoaderWebRootPath Condition=" '$(BroltiLoaderWebRootPath)' == '' ">$([System.IO.Path]::GetFullPath($(PublishDir)wwwroot))\</BroltiLoaderWebRootPath>
      <BroltiLoaderRewriteHtmlFileSearchPattern Condition=" '$(BroltiLoaderRewriteHtmlFileSearchPattern)' == '' ">*.html</BroltiLoaderRewriteHtmlFileSearchPattern>
      <BroltiLoaderRecursive Condition="'$(BroltiLoaderRecursive)'==''">true</BroltiLoaderRecursive>

      <BroltiLoaderBlazorBootJson>$(BroltiLoaderWebRootPath)_framework\blazor.boot.json</BroltiLoaderBlazorBootJson>
      <BroltiLoaderCompressBr>false</BroltiLoaderCompressBr>
      <BroltiLoaderCompressBr Condition="Exists('$(BroltiLoaderBlazorBootJson).br')">true</BroltiLoaderCompressBr>

      <BroltiLoaderInjectLoader Condition=" '$(BroltiLoaderCompressBr)' == 'false' ">false</BroltiLoaderInjectLoader>
      <BroltiLoaderInjectLoader Condition=" '$(BroltiLoaderInjectLoader)' == '' ">true</BroltiLoaderInjectLoader>
      <BroltiLoaderRewriteBaseHref Condition=" '$(BroltiLoaderRewriteBaseHref)' == '' ">false</BroltiLoaderRewriteBaseHref>
      <BroltiLoaderBaseHref Condition=" '$(BroltiLoaderBaseHref)' == '' ">/</BroltiLoaderBaseHref>

      <BroltiLoaderSvcWorkerAssetsJs Condition=" '$(BroltiLoaderSvcWorkerAssetsJs)'=='' AND '$(ServiceWorkerAssetsManifest)' != '' ">$(BroltiLoaderWebRootPath)$(ServiceWorkerAssetsManifest)</BroltiLoaderSvcWorkerAssetsJs>
    </PropertyGroup>
  </Target>

  <Target Name="BlazorWasmBrotliLoader_Inject" AfterTargets="Publish" DependsOnTargets="BlazorWasmBrotliLoader_DefineProperties">

    <!-- Copy brotrli loader script files -->
    <Copy Condition="'$(BroltiLoaderInjectLoader)' == 'true'" SourceFiles="$(MSBuildThisFileDirectory)../bundle/scripts/decode.min.js" DestinationFolder="$(BroltiLoaderWebRootPath)" SkipUnchangedFiles="true" />
    <Copy Condition="'$(BroltiLoaderInjectLoader)' == 'true'" SourceFiles="$(MSBuildThisFileDirectory)../bundle/scripts/brotliloader.min.js" DestinationFolder="$(BroltiLoaderWebRootPath)" SkipUnchangedFiles="true" />

    <!-- Rewrite HTML files (base URL in the "<base href='~'/>" element, and inject Brotli loader) -->
    <BlazorWasmBrotliLoader.RewriteHtml
      WebRootPath="$(BroltiLoaderWebRootPath)"
      FileSearchPatterns="$(BroltiLoaderRewriteHtmlFileSearchPattern)"
      Recursive="$(BroltiLoaderRecursive)"
      InjectBrotliLoader="$(BroltiLoaderInjectLoader)"
      RewriteBaseHref="$(BroltiLoaderRewriteBaseHref)"
      BaseHref="$(BroltiLoaderBaseHref)">
      <Output TaskParameter="RewrittenFiles" ItemName="_BrotliLoader_RewrittenFiles" />
    </BlazorWasmBrotliLoader.RewriteHtml>

    <!-- Recompress static files (Gzip and Brotli) -->
    <BlazorWasmBrotliLoader.RecompressStaticFiles Files="@(_BrotliLoader_RewrittenFiles)" />

    <!-- Update the service wroker assets JavaScript file (Update hash and add hash entries for brotli loader script files) -->
    <BlazorWasmBrotliLoader.UpdateServiceWorkerAssetsManifestJs
      Condition=" '$(BroltiLoaderSvcWorkerAssetsJs)' != '' AND Exists($(BroltiLoaderSvcWorkerAssetsJs))"
      WebRootPath="$(BroltiLoaderWebRootPath)"
      ServiceWorkerAssetsManifestJs="$(BroltiLoaderSvcWorkerAssetsJs)"
      InjectBrotliLoader="$(BroltiLoaderInjectLoader)" />

  </Target>

</Project>